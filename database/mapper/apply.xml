<?xml version="1.0" encoding="UTF-8"?>
<sql id="apply">
	<!-- 申请 -->
	<insert id="addApply">
		insert into 
			apply(user_id,pid,state,auth,auth_detail,content,reason,remarks,gmt_apply)
		value
			(
				{{user_id | q}},
				{{pid | q}},
				{{state | q}},
				{{auth | q}},
				{{auth_detail | q}},
				{{content | q}},
				{{reason | q}},
				{{remarks | q}},
				{{gmt_apply | d}}
			)
	</insert>
	<!-- 直接领导审批 -->
	<update id="leaderReview">
		update
			apply
		set
			pid_reason = {{pid | q}},
			state = {{state | q}},
			gmt_pid = {{gmt_now | dateFormat}}
	</update>
	<!-- 安全审批 -->
	<update id="safeReview">
		update
			apply
		set
			safe_reason = {{pid | q}},
			state = {{state | q}},
			gmt_safe = {{gmt_now | dateFormat}}
	</update>
	<!-- 终极审批 -->
	<update id="finalReview">
		update
			apply
		set
			final_reason = {{pid | q}},
			state = {{state | q}},
			gmt_end = {{gmt_now | dateFormat}}
	</update>

    <!-- 查询信息 -->
    <select id="pageQuery">
        select
            t1.*,t2.name auth_name,t3.name auth_detail_name
        from
            view_apply t1
        where
            1 = 1
            {{id | and:'t1.id'}}
            {{user_id | and:'t1.user_id'}}
            {{pid | and:'t1.pid'}}
            {{state | and:'t1.state'}}
            {{auth | and:'t1.auth'}}
            {{auth_detail | and:'t1.auth_detail'}}
            {{reason | and:'t1.reason'}}
            {{remarks | and:'t1.remarks'}}
            {{pid_reason | and:'t1.pid_reason'}}
            {{safe_reason | and:'t1.safe_reason'}}
            {{final_reason | and:'t1.final_reason'}}
            {{gmt_apply | and:'t1.gmt_apply_start','gte'}}
            {{gmt_apply | and:'t1.gmt_apply_end','lte'}}
            {{gmt_pid | and:'t1.gmt_pid_start','gte'}}
            {{gmt_pid | and:'t1.gmt_pid_end','lte'}}
            {{gmt_safe | and:'t1.gmt_safe_start','gte'}}
            {{gmt_safe | and:'t1.gmt_safe_end','lte'}}
            {{gmt_end | and:'t1.gmt_end_start','gte'}}
            {{gmt_end | and:'t1.gmt_end_end','lte'}}
            {{content | and:'t1.content'}}
            {{sort | orderby}}
            {{offset | limit:pageSize}}
    </select>

    <!-- 查询总数 -->
    <select id="pageCount">
        select
            count(1)
        from
            view_apply t1
        where
            1 = 1
            {{id | and:'t1.id'}}
            {{user_id | and:'t1.user_id'}}
            {{pid | and:'t1.pid'}}
            {{state | and:'t1.state'}}
            {{auth | and:'t1.auth'}}
            {{auth_detail | and:'t1.auth_detail'}}
            {{reason | and:'t1.reason'}}
            {{remarks | and:'t1.remarks'}}
            {{pid_reason | and:'t1.pid_reason'}}
            {{safe_reason | and:'t1.safe_reason'}}
            {{final_reason | and:'t1.final_reason'}}
            {{gmt_apply | and:'t1.gmt_apply_start','gte'}}
            {{gmt_apply | and:'t1.gmt_apply_end','lte'}}
            {{gmt_pid | and:'t1.gmt_pid_start','gte'}}
            {{gmt_pid | and:'t1.gmt_pid_end','lte'}}
            {{gmt_safe | and:'t1.gmt_safe_start','gte'}}
            {{gmt_safe | and:'t1.gmt_safe_end','lte'}}
            {{gmt_end | and:'t1.gmt_end_start','gte'}}
            {{gmt_end | and:'t1.gmt_end_end','lte'}}
            {{content | and:'t1.content'}}
    </select>
</sql>